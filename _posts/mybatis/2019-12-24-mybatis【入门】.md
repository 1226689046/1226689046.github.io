---

layout: post
title: mybatis入门
tags:
- spring
categories: mybatis
description: mybatis入门配置等
---

## Mybatis入门

MyBatis也是对jdbc的一种封装。

hibernate不需要写sql语句了都，但是处理复杂业务的时候很难写。

1. 导入mybatis的开发包

> - mybatis-3.1.1.jar
> - commons-logging-1.1.1.jar
> - log4j-1.2.16.jar
> - cglib-2.2.2.jar
> - asm-3.3.1.jar



2. 准备工作。

   ​	创建一张表

   create table students(
     id  int(5) primary key,
     name varchar(10),
     sal double(8,2)
   );

    

   创建实体类

   ```java
   package com.wsr;
   
   public class Student {
       private Integer id;
       private String name;
       private Double sal;
   
       public Student() {
       }
   
       public Integer getId() {
           return id;
       }
   
       public void setId(Integer id) {
           this.id = id;
       }
   
       public String getName() {
           return name;
       }
   
       public void setName(String name) {
           this.name = name;
       }
   
       public Double getSal() {
           return sal;
       }
   
       public void setSal(Double sal) {
           this.sal = sal;
       }
   }
   ```

创建MyBatis配置文件

```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE configuration PUBLIC "-//mybatis.org//DTD Config 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-config.dtd">

<configuration>
    <!-- 加载类路径下的属性文件 -->
    <properties resource="db.properties"/>
<!--    设置一个默认的连接环境  default是当前使用哪个-->
    <environments default="mysql_developer">

<!--        连接环境信息 有一个唯一的id-->
        <environment id="mysql_developer">
<!--           mybatis使用jdbc的事务管理方式 -->
            <transactionManager type="jdbc"></transactionManager>
<!--使用连接池的方式-->
            <dataSource type="pooled">
<!--                四个必要属性-->
                <property name="driver" value="${jdbc.driver}"/>
                <property name="url" value="${jdbc.url}"/>
                <property name="username" value="${jdbc.username}"/>
                <property name="password" value="${jdbc.password}"/>
            </dataSource>
        </environment>
    </environments>
</configuration>
```

mybatis工具类

```java
package com.wsr;

import org.apache.ibatis.io.Resources;
import org.apache.ibatis.session.SqlSession;
import org.apache.ibatis.session.SqlSessionFactory;
import org.apache.ibatis.session.SqlSessionFactoryBuilder;

import java.io.Reader;
import java.sql.Connection;

public class MyBatisUtil {
    private static ThreadLocal<SqlSession> threadLocal = new ThreadLocal<>();
    private static SqlSessionFactory sqlSessionFactory ;

    /**
     * 加载mybatis的配置文件
     */
    static {
        try {
            Reader reader = Resources.getResourceAsReader("mybatis.xml");
            sqlSessionFactory = new SqlSessionFactoryBuilder().build(reader);
        }catch (Exception e){
            e.printStackTrace();
            throw new RuntimeException(e);
        }
    }

//    私有构造哈数
    private MyBatisUtil(){

    }


    /**
     * 获取SqlSession
     *
     *
     */

    public static SqlSession getSqlSession(){
        //从当前线程中获取
        SqlSession sqlSession = threadLocal.get();
        if (sqlSession == null){
            sqlSession = sqlSessionFactory.openSession();
            //将SqlSession对象与当前线程绑定在一起
            threadLocal.set(sqlSession);
        }
        return sqlSession;
    }


    /**
     * 关闭
     */
    public static void closeSession(){
        //从当前线程中获取
        SqlSession sqlSession = threadLocal.get();
        if (sqlSession!=null){
            sqlSession.close();
            //分开当前线程与SqlSession对象的关系，目的是让GC尽早回收
            threadLocal.remove();
        }
    }

    public static void main(String[] args) {
        Connection connection = getSqlSession().getConnection();
        System.out.println(connection == null ? "失败" : "成功");
    }
}

```

创建实体与表的映射关系  mapper.xml

```xml
<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.wsr.Student">
    <resultMap id="studentMap" type="com.wsr.Student">
        <id property="id" column="id"></id>
        <result property="name" column="name"/>
        <result property="sal" column="sal"/>
    </resultMap>

    <insert id="insert" parameterType="com.wsr.Student">
        insert into students (id,name,sal) values(#{id},#{name},#{sal})
    </insert>
</mapper>
```



在mybatis.xml配置文件中添加
<mappers>    <mapper resource="mapper/studentmapper.xml"/></mappers>





dao层

```java

import org.apache.ibatis.session.SqlSession;

public class StudentDao {
    public void add(Student student){
        SqlSession sqlSession = MyBatisUtil.getSqlSession();
        sqlSession.insert("insert",student);
        sqlSession.commit();
    }

    public static void main(String[] args) {
        StudentDao studentDao = new StudentDao();
        Student s = new Student();
        s.setId(1);
        s.setName("啊啊啊");
        s.setSal(1.1);
        studentDao.add(s);
    }
}

```





### MyBatis工作流程

- **通过Reader对象读取Mybatis配置文件**
- **通过SqlSessionFactoryBuilder对象创建SqlSessionFactory对象**
- **获取当前线程的SQLSession**
- **事务默认开启**
- **通过SQLSession读取映射文件中的操作编号，从而读取SQL语句**
- **提交事务**
- **关闭资源**



完成curd操作

先在实体类的mapper中配置sql

使用sqlSession进行操作





#### MyBatis分页

```xml
<select id="selectLimit" parameterType="map" resultMap="studentMap">
        select * from students limit #{start},#{end}
    </select>
```

```java
 public void selectLimit(){
        Map<String,Integer> m = new HashMap<>();
        m.put("start",0);
        m.put("end",1);
        List<Student> l = MyBatisUtil.getSqlSession().selectList("selectLimit",m);
        System.out.println(l);
    }
```

#### 动态sql

动态查询



select * from students where ... 所以是where标签

```xml
 <select id="findByCondition" resultMap="studentMap" parameterType="map">
        select * from students
        <where>
            <if test="name!=null">
                and name=#{name}
            </if>
            <if test="sal!=null">
                and sal < #{sal}
            </if>
        </where>

    </select>
```

动态更新



update students set....  所以是set标签

```xml
 <!--动态更新-->
    <!--不要忘了逗号-->
    <update id="updateByConditions" parameterType="map">

        update students
        <set>
            <if test="name!=null">
                name = #{name},
            </if>
            <if test="sal!=null">
                sal = #{sal},
            </if>
        </set>
        where id = #{id}
    </update>
```



delete from students where id in (1,2,3)

```xml
 <delete id="deleteByConditions" parameterType="int">

        <!-- foreach用于迭代数组元素
             open表示开始符号
             close表示结束符合
             separator表示元素间的分隔符
             item表示迭代的数组，属性值可以任意，但提倡与方法的数组名相同
             #{ids}表示数组中的每个元素值
         -->
        delete from students where id in
        <foreach collection="array" open="(" close=")" separator="," item="ids">
            #{ids}
        </foreach>

    </delete>
```

动态插入



```xml
 <!--SQL片段默认是不帮我们自动生成合适的SQL，因此需要我们自己手动除去逗号-->
    <sql id="key">
        <trim suffixOverrides=",">
            <if test="id!=null">
                id,
            </if>

            <if test="id!=null">
                name,
            </if>

            <if test="id!=null">
                sal,
            </if>
        </trim>
    </sql>

    <sql id="value">
        <trim suffixOverrides=",">
            <if test="id!=null">
                #{id},
            </if>

            <if test="id!=null">
                #{name},
            </if>

            <if test="id!=null">
                #{sal},
            </if>
        </trim>
    </sql>
    <!--动态插入-->
    <insert id="insertByConditions" parameterType="zhongfucheng.Student">

        insert into students (<include refid="key"/>) values
        (<include refid="value"/>)

    </insert>
```

